<!doctype html>
<html style="height: 100%;">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <base href="/">
    <title>Puzzle piece preview</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <style>
        #container {
            margin: 50px;
            position: relative;
        }

        .puzzle-piece {
            /* border: 1px solid; */
        }

        svg {
            /* transform: scale(.99); */
        }
    </style>
  </head>
  <body style="margin: 0;">
    <div id="container">
        <h2>Piece size:</h2>
        <input id="piece-size" type="text" />
        <h2>Piece types to generate:</h2>
        <input id="piece-types" type="text" />
        <h2>Generator result:</h2>
        <div id="generator-result"></div>
        <button id="submit">Go</button>
    </div>
    <script type="module">
        const types = [
            [0,1,1,0],
            [0,1,0,1],
            [1,1,1,1],
            [1,0,1,0],
        ];

        // Initial values
        let pieceSize = 200;
        let pieceTypes = types[1];
        
        const strokeWidth = 1;
        const pathOffsetX = -1.5;
        const pathOffsetY = -.2;

        const pieceSizeField = document.getElementById("piece-size");
        const strokeWidthField = document.getElementById("stroke-width");
        const pieceTypesField = document.getElementById("piece-types");
        const goButton = document.getElementById("submit");
        const resultElement = document.getElementById("generator-result");

        pieceSizeField.value = pieceSize;
    
        pieceSizeField.addEventListener("focusout", e => {
            pieceSize = parseInt(e.target.value);
        });

        pieceTypesField.addEventListener("keyup", e => {
            const input = e.target.value;
            pieceTypes = types[parseInt(input)];
        });

        function fetchPreview(request){
            fetch("api/generator-test", {
                method: 'post',
                headers: {
                    'Content-Type': 'Application/json'
                },
                body: JSON.stringify(request)
            })
            .then(response => response.json())
            .then(onFetchSuccess)
        }

        function onFetchSuccess(response){
            const connectorSize = response.generator.connectorSize;
                
            for(let i=0, l=response.generatedPieces.length; i<l; i++){
                const currentPiece = response.generatedPieces[i];
                
                let width = pieceSize;
                let height = pieceSize;
                
                if(currentPiece.pieceType[0] === 1){
                    height += connectorSize;
                }
                
                if(currentPiece.pieceType[1] === 1){
                    width += connectorSize;
                }
                
                if(currentPiece.pieceType[2] === 1){
                    height += connectorSize;
                }
                
                if(currentPiece.pieceType[3] === 1){
                    width += connectorSize;
                }
                
                const element = document.createElement("div");
                element.id = `puzzle-piece-${i}`;
                element.classList.add("puzzle-piece")
                element.style.width = width + 10 + "px";
                element.style.height = height + 10 + "px";

                const svg = getSvg(
                    width,
                    height,
                    response.generatedPieces[0].svgString
                );
                element.appendChild((svg));
                resultElement.innerHTML = "";
                resultElement.appendChild(element);
            }
        }

        goButton.addEventListener("click", e => {
            fetchPreview({
                pieceSize,
                pieceTypes,
                strokeWidth,
            });
        })

        function getSvg(width, height, svgPathString){
            const clipId = `svg-1`;

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            // svg.setAttribute("id", `piece-svg-1`);
            svg.classList.add("svg-container");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            // svg.setAttribute("viewBox", "0 0 100% 100%");
            // svg.setAttribute("style", `transform: scale(calc(1 - ${(strokeWidth * 2) / 1000}))`);

            const clipPath = document.createElementNS("http://www.w3.org/2000/svg", "clipPath");
            clipPath.setAttribute("id", clipId);

            const clipPathPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
            clipPathPath.setAttribute("d", svgPathString);
            clipPathPath.setAttribute("style", `transform: scale(106%) translateX(${pathOffsetX}%) translateY(${pathOffsetY}%);`)
            clipPath.appendChild(clipPathPath);
            
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.setAttribute("clip-path", `url(#${clipId})`);
            
            const gImage = document.createElementNS("http://www.w3.org/2000/svg", "image");
            gImage.setAttribute("href", "./beach.jpeg");
            gImage.classList.add("svg-image")
            gImage.setAttribute("id", `svg-image-1`);
            gImage.setAttribute("x", -400);
            gImage.setAttribute("y", -400);
            g.appendChild(gImage);
            
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", svgPathString);
            path.setAttribute("stroke", "#000");
            path.setAttribute("vector-effect", "non-scaling-stroke");
            path.setAttribute("stroke-width", strokeWidth);
            path.setAttribute("stroke-line-join", "miter");
            path.setAttribute("style", `transform: scale(106%) translateX(${pathOffsetX}%) translateY(${pathOffsetY}%);`)

            svg.appendChild(path);
            svg.appendChild(g);
            svg.appendChild(clipPath);

            return svg;
        }

        // const svgElement = getSvg(svgString);
        // const container = document.getElementById("container");
        // container.appendChild(svgElement);

        fetchPreview({
            pieceSize,
            pieceTypes,
            strokeWidth,
        });
    </script>
</body>
</html>